# 2025-08-22 Work Session

## Context

- Project: [[AreYouJ]]
- Focus Area: Multi-Agent System Architecture Planning
- Analysis Target: Omnara vs AreYouJ Comparison and Migration Plan
- Previous Session: Initial planning session

## Work Completed

### Multi-Agent System Architecture Analysis

프로젝트를 다중 에이전트 시스템으로 확장하기 위한 체계적 분석 수행

#### Current AreYouJ Architecture Analysis
- Files analyzed: `src/App.tsx`, `server/index.js`, `claude_pty_wrapper.py`
- **Single Terminal Limitation**: 현재 하나의 터미널 세션만 지원
- **Sequential Processing**: 순차적인 메시지 처리만 가능
- **Single Project Path**: 하나의 프로젝트 경로만 설정 가능

#### Omnara Reference Analysis
- **Multi-Agent Core Models**: User, UserAgent, AgentInstance, Message, APIKey
- **Independent Execution**: 에이전트별 독립적인 실행 환경
- **Real-time Streaming**: Server-Sent Events 기반 실시간 통신
- **State Management**: ACTIVE, AWAITING_INPUT, COMPLETED 상태 관리

## Technical Decisions

### 🚨 Critical Architecture Decision: Database Separation

- **Choice**: **데이터베이스 도메인 분리** - `tasks.db` + `agents.db`
- **Reasoning**:
  - **Single Responsibility**: tasks.db는 업무 목록만, agents.db는 에이전트 관리만
  - **Domain Isolation**: 서로 다른 도메인의 명확한 분리
  - **Maintainability**: 각 도메인별로 독립적인 스키마 진화 가능
  - **Stability**: 기존 tasks.db 구조 완전 보존
- **Previous Mistake**: tasks.db에 agents/agent_instances 테이블 추가 계획 (잘못된 설계)
- **Impact**: 깔끔한 아키텍처, 향후 확장성 확보, 코드 유지보수성 향상

### Multi-Agent Architecture Strategy

- **Choice**: Omnara 레퍼런스 기반 점진적 확장
- **Reasoning**:
  - **UserAgent**: 사용자 정의 에이전트 타입 (이름, 프로젝트 경로, 설정)
  - **AgentInstance**: 각 에이전트의 실행 인스턴스 (상태, 메시지 히스토리) 
  - **독립 세션**: 에이전트별 독립적인 PTY 프로세스
- **Alternatives Considered**: 완전 재작성 vs 점진적 확장
- **Impact**: 기존 코드베이스 활용하면서 Multi-Agent 기능 추가

### Database Schema Evolution Strategy

- **Choice**: SQLite 유지 + **이중 데이터베이스** 방식
- **Reasoning**: 
  - 로컬 개발 환경에 적합한 경량 솔루션
  - **도메인별 분리**: tasks.db (업무) + agents.db (에이전트)
  - PostgreSQL 대비 설정 복잡도 최소화
- **Alternatives Considered**: PostgreSQL 전환, NoSQL 솔루션, 단일 DB 확장
- **Impact**: 명확한 책임 분리, 향후 각 도메인별 독립 확장 가능

### Session Management Architecture

- **Choice**: PTY 프로세스별 독립 세션 관리
- **Reasoning**: 
  - 에이전트간 완전한 격리 보장
  - 동시 실행 시 충돌 방지
  - 각 에이전트의 독립적인 환경 상태 유지
- **Impact**: 메모리 사용량 증가, 관리 복잡도 상승

## Implementation Plan

### Phase 1: Database Extension with Separation (Priority 1)

#### 🆕 새로운 `agents.db` 생성
```sql
-- agents.db - 에이전트 정의
CREATE TABLE agents (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  project_path TEXT NOT NULL,
  description TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 에이전트 실행 인스턴스
CREATE TABLE agent_instances (
  id TEXT PRIMARY KEY,
  agent_id TEXT REFERENCES agents(id) ON DELETE CASCADE,
  status TEXT DEFAULT 'idle', -- idle, active, completed, error, terminated
  started_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  completed_at DATETIME NULL,
  pty_session_id TEXT NULL,
  project_path TEXT NOT NULL,
  last_activity_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 에이전트-사용자 간 메시지  
CREATE TABLE agent_messages (
  id TEXT PRIMARY KEY,
  agent_instance_id TEXT REFERENCES agent_instances(id) ON DELETE CASCADE,
  sender_type TEXT NOT NULL, -- 'user' or 'agent'
  content TEXT NOT NULL,
  requires_user_input BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 에이전트별 설정 (향후 확장용)
CREATE TABLE agent_settings (
  agent_id TEXT PRIMARY KEY REFERENCES agents(id) ON DELETE CASCADE,
  auto_start BOOLEAN DEFAULT FALSE,
  notification_enabled BOOLEAN DEFAULT TRUE,
  max_concurrent_instances INTEGER DEFAULT 1,
  settings_json TEXT DEFAULT '{}'
);
```

#### 🔄 기존 `tasks.db` 보존
```sql
-- tasks.db는 그대로 유지 (변경 없음)
CREATE TABLE tasks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'pending',
  priority TEXT DEFAULT 'medium',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Phase 2: Backend API Enhancement with Dual Database
#### 📁 파일 구조 변경
```
server/
├── db/
│   ├── sqlite.js           # 기존: tasks.db 관리
│   └── agents-sqlite.js    # 신규: agents.db 관리
└── routes/
    ├── api.js              # 기존: tasks API
    └── agents-api.js       # 신규: agents API
```

#### 🔌 API 엔드포인트 분리
```javascript
// 기존 tasks API (변경 없음)
GET  /api/tasks
POST /api/tasks
PUT  /api/tasks/:id
DELETE /api/tasks/:id

// 신규 agents API
GET    /api/agents                    # 에이전트 목록
POST   /api/agents                    # 에이전트 생성
PUT    /api/agents/:id               # 에이전트 수정
DELETE /api/agents/:id               # 에이전트 삭제

GET    /api/agents/:id/instances     # 특정 에이전트의 인스턴스 목록
POST   /api/agents/:id/instances     # 새 인스턴스 생성
PUT    /api/instances/:id            # 인스턴스 상태 업데이트
DELETE /api/instances/:id            # 인스턴스 종료/삭제

GET    /api/instances/:id/messages   # 인스턴스 메시지 목록
POST   /api/instances/:id/messages   # 메시지 전송
```

- **Multi-Session WebSocket**: 세션 ID 기반 채널 분리
- **Multi-Database Connection**: tasks.db + agents.db 동시 관리
- **Domain-Specific APIs**: 각 도메인별 독립적인 API 구조

### Phase 3: Frontend UI Overhaul
- **Multi-Agent Dashboard**: 에이전트별 상태 모니터링
- **Tab-based Interface**: 에이전트 간 전환 UI
- **Independent Terminal Views**: 각 에이전트의 독립적인 터미널 뷰

### Phase 4: Session Orchestration System
- **Dynamic PTY Creation**: 요청 시 새 PTY 프로세스 생성
- **Session Routing**: 세션 ID 기반 메시지 라우팅
- **Resource Management**: PTY 프로세스 생명주기 관리

## Updated Target Architecture Vision

### 🏗️ Multi-Database Architecture
```
docs/
├── tasks.db          # 업무 목록 전용 (기존 유지)
└── agents.db         # 다중 에이전트 관리 전용 (신규)
```

#### Database Relationship Design
```
agents ──→ agent_instances ──→ agent_messages
  ↓              ↓                    ↓
1:N            1:N                  1:N
```

### 🔗 Database Relations & Integrity
- **agents** → **agent_instances**: 1:N (한 에이전트가 여러 인스턴스 실행 가능)
- **agent_instances** → **agent_messages**: 1:N (한 인스턴스가 여러 메시지 포함)
- **Cascade Deletion**: 에이전트 삭제 시 관련 인스턴스와 메시지 모두 삭제
- **Referential Integrity**: FK 제약 조건으로 데이터 일관성 보장

### Architecture Benefits
#### ✅ 단일 책임 원칙 (Single Responsibility Principle)
- **tasks.db**: 업무 목록 관리 전담
- **agents.db**: 에이전트 시스템 관리 전담
- 각 데이터베이스가 명확한 도메인 경계 유지

#### 🚀 확장성 및 유지보수성
- **독립적 스키마 진화**: 각 DB가 독립적으로 확장 가능
- **안정성**: 기존 tasks.db 구조 100% 보존
- **모듈성**: 도메인별로 분리된 코드베이스
- **테스트 용이성**: 각 도메인별 단위 테스트 가능

#### 💡 향후 확장 가능성
- **마이크로서비스 전환**: 각 DB를 별도 서비스로 분리 용이
- **성능 최적화**: 도메인별 최적화 전략 적용 가능
- **백업 및 복구**: 도메인별 독립적인 백업 정책

### Expected System Improvements
- ✅ **Multi-Project Support**: 여러 프로젝트에서 동시 작업 가능
- ✅ **Independent Execution**: 에이전트별 독립적인 실행 환경
- ✅ **Centralized Monitoring**: 중앙 집중식 상태 관리 및 모니터링
- ✅ **Intuitive Multi-Agent UI**: 직관적인 다중 에이전트 사용자 인터페이스
- ✅ **Scalable Architecture**: 동적 에이전트 추가/제거 지원
- ✅ **Resource Isolation**: 에이전트 간 완전한 리소스 격리

### Updated Implementation Roadmap
1. **Phase 1**: Database Separation & Extension ⏳ (1-2 days)
   - [ ] `agents.db` 생성 스크립트 작성
   - [ ] `server/db/agents-sqlite.js` 모듈 구현
   - [ ] 테이블 관계 및 인덱스 설정

2. **Phase 2**: Backend API Extension ⏳ (3-4 days) 
   - [ ] `server/routes/agents-api.js` 구현
   - [ ] Multi-database 연결 관리 (tasks.db + agents.db)
   - [ ] WebSocket 이벤트를 에이전트별로 분리

3. **Phase 3**: Frontend UI Redesign ⏳ (5-7 days)
   - [ ] Multi-Agent Dashboard UI
   - [ ] 에이전트별 독립적인 터미널 뷰

4. **Phase 4**: Session Orchestration ⏳ (3-5 days)
   - [ ] 에이전트별 PTY 세션 관리
   - [ ] 세션 라우팅 및 격리

**Total Estimated Timeline**: 2-3 weeks for complete Multi-Agent System

## Discovered Patterns

### Omnara Success Patterns
- **Stateful Agent Management**: 상태 기반 에이전트 제어의 효과성
- **Real-time Communication**: SSE를 통한 안정적인 실시간 통신
- **Centralized Monitoring**: 중앙 집중식 모니터링의 사용성 개선 효과

### AreYouJ Strength Patterns
- **Direct PTY Control**: 터미널 직접 제어의 안정성과 성능
- **Local SQLite**: 로컬 환경에서의 빠른 응답성
- **WebSocket Efficiency**: 양방향 통신의 효율성

## Technical Challenges

### Session Isolation Challenge
- **Problem**: 에이전트별 독립적인 환경 격리
- **Complexity**: PTY 프로세스간 리소스 관리
- **Solution Direction**: Docker 컨테이너 또는 프로세스 네임스페이스 활용

### State Synchronization Challenge
- **Problem**: 다중 세션의 상태 동기화
- **Risk**: Race condition 및 데이터 일관성 문제
- **Mitigation**: Lock 기반 동기화 메커니즘 필요

## Code References

### Key Implementation Files
- Current: `server/index.js:45-120` - WebSocket 핸들러
- Target: `claude_pty_wrapper.py` - 다중 세션 지원으로 확장 필요
- Database: `docs/tasks.db` - 스키마 확장 대상

### Omnara Reference Points
- `claude_wrapper_v3.py` - 양방향 Claude 통신 참조
- Database models - PostgreSQL 스키마 SQLite 변환 참조

## Learning Notes

### Multi-Agent System Design Principles
- **Isolation**: 각 에이전트는 독립적인 실행 환경 필요
- **Scalability**: 동적 에이전트 추가/제거 지원
- **Monitoring**: 중앙 집중식 상태 모니터링 필수
- **Communication**: 실시간 양방향 통신 채널 구축

### Implementation Complexity Assessment
- **High**: Session isolation and resource management
- **Medium**: Database schema evolution and API extension
- **Low**: Frontend UI adaptation (기존 컴포넌트 재사용 가능)

## Next Session Focus

### Immediate Tasks (Next 1-2 Sessions)
- [ ] **새 `agents.db` 생성 스크립트** 작성
- [ ] **Multi-database 연결** 관리 모듈 구현
- [ ] **도메인별 API 라우터** 분리 (`agents-api.js`)
- [ ] **WebSocket 이벤트** 에이전트별 분리 설계

### Short-term Goals (1 Week)
- [ ] Phase 1 완료: **Database separation** (`tasks.db` + `agents.db`)
- [ ] **Dual-database** CRUD API 구현
- [ ] 프론트엔드 **에이전트 생성/관리 UI** 프로토타입

### Medium-term Vision (1 Month)
- [ ] 완전한 다중 에이전트 시스템 동작
- [ ] 성능 최적화 및 안정성 검증
- [ ] 사용자 피드백 기반 UX 개선

## Questions for Next Session

1. **Database Connection Pool**: `tasks.db`와 `agents.db` 동시 연결 시 connection pooling 전략은?
2. **Cross-Database Queries**: 에이전트와 태스크 간의 연관관계가 필요한 경우 처리 방법은?
3. **Migration Strategy**: 기존 프로젝트 설정을 `agents.db`로 어떻게 이전할 것인가?
4. **Resource Limits**: 동시 실행 가능한 에이전트 수의 제한은 어떻게 설정할 것인가?

## Key Insights

### Strategic Direction
🎯 **Database Domain Separation First**: 아키텍처의 기반을 올바르게 설계하는 것이 핵심. `tasks.db`와 `agents.db`의 명확한 분리를 통해 **단일 책임 원칙**을 준수하고, 향후 확장성과 유지보수성을 확보.

AreYouJ는 단일 세션의 안정성을 기반으로 다중 에이전트로 확장하는 **점진적 진화** 전략이 적합. 하지만 **올바른 데이터베이스 아키텍처**를 먼저 구축한 후 기능을 확장해야 함.

### Success Metrics
- **Concurrent Sessions**: 3-5개 에이전트 동시 실행 안정성
- **Response Time**: 에이전트 간 전환 시 1초 이내 응답
- **Resource Usage**: 메모리 사용량 에이전트당 100MB 이하 유지