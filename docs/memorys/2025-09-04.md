# 2025-09-04 Work Session

## Context

- Project: [[AreYouJ]]
- Focus Area: Multi-Session Architecture Planning
- Previous Session: First session
- Goal: Document Opcode ProcessRegistry pattern porting strategy

## Work Completed

### Current Architecture Analysis

기존 AreYouJ 프로젝트의 Claude 세션 관리 구조를 분석했습니다:

- **Current Implementation**: `ClaudeSessionManager` 싱글톤 패턴
- Files analyzed:
  - `server/claude/session-manager.js:16-1476` - 메인 세션 관리자
  - `server/claude/claude_pty_wrapper.py` - Python PTY 래퍼
  - `docs/PROJECT_ANALYSIS.md:1-169` - 기존 프로젝트 문서

### Architecture Assessment

현재 구조의 특징:
- **Singleton Pattern**: `getClaudeSession()` 함수로 단일 인스턴스 관리
- **Message Queue**: 메시지 큐 기반 자동 처리 시스템
- **PTY Integration**: Python 래퍼를 통한 Claude CLI 제어
- **State Management**: 세션 상태, 건강 상태 체크, 자동 복구
- **Persistence**: 디렉토리별 큐 저장 및 복구

## Technical Decisions

### Multi-Session Architecture Strategy

**Choice**: Opcode ProcessRegistry 패턴을 차용한 SessionRegistry 구현

**Reasoning**:
1. **Proven Pattern**: Opcode에서 검증된 다중 프로세스 관리 패턴
2. **Minimal Disruption**: 기존 ClaudeSessionManager 로직 90% 재사용 가능
3. **Scalability**: 세션별 독립적 관리로 확장성 확보
4. **Resource Management**: 세션 생성/삭제/정리의 체계적 관리

**Alternatives Considered**:
- Factory Pattern: 세션 생성에 국한, 관리 기능 부족
- Pool Pattern: 리소스 재사용 중심, 개별 세션 상태 관리 어려움
- Observer Pattern: 이벤트 중심, 직접적인 세션 제어 복잡

**Impact**:
- 기존 API 호환성 유지 가능
- 점진적 마이그레이션 허용
- 메모리 사용량 증가 (세션당 독립적 상태)

### Implementation Plan Structure

**Choice**: 4주 단계별 구현

**Phase Breakdown**:
1. **Week 1**: Backend Core (SessionRegistry + ClaudeSession)
2. **Week 2**: API Extension + WebSocket Namespacing
3. **Week 3**: Frontend UI (SessionTabs + Terminal Enhancement)
4. **Week 4**: Optimization + Performance Tuning

**Impact**: 각 단계별 독립적 테스트 및 검증 가능

## Discovered Patterns

### 기존 코드의 우수한 패턴들

1. **Robust Error Handling**: 
   - Connection failures, timeout handling
   - Message queue integrity validation
   - Graceful degradation patterns

2. **State Persistence**:
   - Directory-based queue management
   - Automatic backup and recovery
   - Session state recovery on restart

3. **Process Management**:
   - Health check mechanisms
   - Graceful shutdown procedures
   - Process lifecycle management

이러한 패턴들은 다중 세션 구현 시에도 그대로 활용할 예정입니다.

## Architecture Design

### New Architecture Components

```javascript
// 1. SessionRegistry (New)
class SessionRegistry {
  constructor() {
    this.sessions = new Map(); // sessionId -> ClaudeSession
    this.activeSessionId = null;
    this.defaultConfig = {};
  }
  
  createSession(sessionId, config)
  getSession(sessionId) 
  deleteSession(sessionId)
  getAllSessions()
  setActiveSession(sessionId)
}

// 2. ClaudeSession (Refactored from ClaudeSessionManager)
class ClaudeSession extends EventEmitter {
  constructor(sessionId, config) {
    // 기존 ClaudeSessionManager 로직 이전
    // sessionId 기반 독립적 상태 관리
  }
}

// 3. Legacy Compatibility
export function getClaudeSession() {
  // 기존 싱글톤 패턴 호환성 유지
  return sessionRegistry.getDefaultSession();
}
```

### API Changes

새로운 다중 세션 API:
```javascript
// Session Management
POST   /api/sessions              // Create new session
GET    /api/sessions              // List all sessions  
DELETE /api/sessions/:id          // Delete session
PUT    /api/sessions/:id/active   // Set active session

// Session-specific operations
POST   /api/sessions/:id/messages // Send message to specific session
GET    /api/sessions/:id/queue    // Get session queue
GET    /api/sessions/:id/status   // Get session status
```

WebSocket 네임스페이싱:
```javascript
// Session-specific events
socket.emit('session:123:message', data);
socket.on('session:123:output', handler);
socket.on('session:123:status-changed', handler);
```

## Implementation Details

### File Structure Changes

```
server/claude/
├── session-manager.js       # Legacy (deprecated)
├── session-registry.js      # NEW: SessionRegistry class
├── claude-session.js        # NEW: Refactored session logic
├── session-config.js        # NEW: Session configuration
└── utils/
    ├── session-utils.js     # NEW: Utility functions
    └── migration-utils.js   # NEW: Legacy migration helpers
```

### Migration Strategy

1. **Phase 1**: SessionRegistry 구현 (기존 코드와 병렬)
2. **Phase 2**: ClaudeSession 분리 및 테스트
3. **Phase 3**: API 확장 (기존 API 유지)
4. **Phase 4**: Frontend 업데이트
5. **Phase 5**: Legacy deprecation

## Next Session

### Immediate Tasks
- [ ] SessionRegistry 클래스 구조 설계 및 인터페이스 정의
- [ ] ClaudeSession 클래스로 기존 로직 분리
- [ ] Session configuration schema 설계
- [ ] Unit test 기본 구조 설정

### Follow-up Items
- [ ] WebSocket namespacing 전략 구체화
- [ ] Frontend SessionTabs 컴포넌트 mockup
- [ ] Memory usage optimization 계획
- [ ] Session persistence 스키마 설계

### Questions to Explore
- Session ID 생성 전략 (UUID vs Sequential vs Custom)
- 최대 동시 세션 수 제한 정책
- Idle session cleanup 정책
- Session간 메시지/컨텍스트 공유 필요성

### Design Decisions Pending
- Session configuration 우선순위 (global vs session-specific)
- Error handling 전략 (session-level vs registry-level)
- Performance monitoring 및 metrics 수집 방안

## Code References

### Key Implementation Points
- Current singleton: `server/claude/session-manager.js:1468-1476`
- Message processing: `server/claude/session-manager.js:1236-1373`
- PTY wrapper integration: `server/claude/session-manager.js:456-461`
- Queue persistence: `server/claude/session-manager.js:289-326`
- WebSocket events: `server/websocket/index.js`

### Frontend Integration Points
- Terminal component: `src/components/Automation.tsx`
- API communication: `src/utils/api.ts`
- Terminal utilities: `src/utils/claude-terminal.js`

## Learning Notes

### Opcode ProcessRegistry Insights
- Simple Map-based process storage
- Clear lifecycle management (create/get/delete)
- Event-driven state notifications
- Resource cleanup on process exit

### AreYouJ Architecture Strengths
- Comprehensive error handling and recovery
- State persistence and queue management
- Health monitoring and automatic restart
- Chunked message sending for large inputs

### Implementation Considerations
- Memory footprint per session
- Process handle limits
- WebSocket connection scaling
- Queue file I/O optimization

이 문서는 AreYouJ 프로젝트의 다중 Claude 세션 지원을 위한 핵심 설계 문서입니다. Opcode의 단순하면서도 효과적인 ProcessRegistry 패턴을 차용하여 기존 코드의 안정성과 기능을 유지하면서 확장성을 확보하는 것이 목표입니다.